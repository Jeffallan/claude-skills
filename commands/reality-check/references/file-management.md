# Reality File Management

> Reference for: Reality Check
> Load when: Storage operations, project identification, file format

---

## Directory Structure

Reality files are stored in the user's Claude home directory:

```
~/.claude/reality-check/
├── index.md                              # Global registry of all projects
└── {project-id}/
    ├── reality.md                        # Human-readable assumptions
    ├── reality.index.json                # Machine-readable index
    └── archive/
        └── {timestamp}-{reason}.md       # Archived versions (future)
```

---

## Project Identification

### Primary Method: Git Remote

```bash
git remote get-url origin 2>/dev/null
```

**Example outputs:**
- `https://github.com/user/repo.git` -> project_id: `github.com/user/repo`
- `git@github.com:user/repo.git` -> project_id: `github.com/user/repo`

**Normalization rules:**
1. Remove protocol prefix (`https://`, `git@`)
2. Remove `.git` suffix
3. Replace `:` with `/` for SSH URLs
4. Use as directory name (URL-safe characters)

### Fallback Method: Path-Based

If no git remote found:

```bash
pwd
```

**Example:**
- `/home/user/projects/my-app` -> project_id: `local/home-user-projects-my-app`

**Normalization rules:**
1. Prefix with `local/`
2. Replace `/` with `-`
3. Remove leading slash

---

## Global Index (index.md)

Located at: `~/.claude/reality-check/index.md`

### Template

```markdown
# Reality Check: Project Registry

Last Updated: {timestamp}

## Tracked Projects

| Project | ID | Assumptions | Last Check |
|---------|----|-----------:|------------|
| {name} | {project_id} | {count} | {date} |

---

*Auto-generated by /reality-check command*
```

### Update Rules

- Add new project when first reality file created
- Update counts and dates on each /reality-check run
- Remove projects when reality file deleted (future --reset)

---

## Reality File (reality.md)

Located at: `~/.claude/reality-check/{project_id}/reality.md`

### Template

```markdown
# Project Reality Check

**Project:** {project_name}
**Project ID:** {project_id}
**Created:** {created_timestamp}
**Last Updated:** {updated_timestamp}

---

## ESTABLISHED

High confidence assumptions. Treat as premises.

### {id}: {title}

- **Type:** {stated|inferred|assumed}
- **Assumption:** {description}
- **Source:** {evidence or citation}
- **Validated:** {date}
- **Context:** {when this applies}

---

## WORKING

Medium confidence. Use but flag if contradicted.

### {id}: {title}

- **Type:** {stated|inferred|assumed}
- **Assumption:** {description}
- **Source:** {evidence or citation}
- **Validated:** {date}
- **Context:** {when this applies}

---

## OPEN

Low confidence. Ask before assuming.

### {id}: {title}

- **Type:** {stated|inferred|assumed|uncertain}
- **Assumption:** {description}
- **Source:** {evidence or citation}
- **Validated:** {date}
- **Context:** {when this applies}

---

## History

| Date | Action | ID | Details |
|------|--------|------|---------|
| {date} | {Created/Promoted/Demoted/Archived} | {id} | {details} |

---

*Managed by /reality-check command*
```

### Assumption ID Format

Format: `A{number}` (e.g., A001, A002, A003)

- Sequential within project
- Never reused (even after archival)
- Track highest ID in index.json

---

## Machine Index (reality.index.json)

Located at: `~/.claude/reality-check/{project_id}/reality.index.json`

### Schema

```json
{
  "version": "1.0",
  "project_id": "{project_id}",
  "project_name": "{human_readable_name}",
  "created": "{ISO_timestamp}",
  "last_updated": "{ISO_timestamp}",
  "next_id": 4,
  "assumptions": [
    {
      "id": "A001",
      "title": "{short_title}",
      "type": "stated|inferred|assumed|uncertain",
      "tier": "ESTABLISHED|WORKING|OPEN",
      "assumption": "{full_description}",
      "source": "{evidence}",
      "validated": "{ISO_date}",
      "context": "{when_applies}",
      "created": "{ISO_timestamp}",
      "history": [
        {
          "date": "{ISO_timestamp}",
          "action": "created|promoted|demoted",
          "from_tier": null,
          "to_tier": "WORKING",
          "reason": "{optional}"
        }
      ]
    }
  ],
  "archived": []
}
```

### Field Definitions

| Field | Type | Description |
|-------|------|-------------|
| `version` | string | Schema version for migrations |
| `project_id` | string | Unique project identifier |
| `project_name` | string | Human-readable project name |
| `next_id` | number | Next assumption ID to assign |
| `assumptions` | array | Active assumptions |
| `archived` | array | Archived assumptions (future) |

---

## File Operations

### Create New Reality File

1. Check if `~/.claude/reality-check/` exists, create if not
2. Create `{project_id}/` directory
3. Write `reality.md` from template
4. Write `reality.index.json` with empty assumptions
5. Update global `index.md`

### Update Existing Reality File

1. Read `reality.index.json`
2. Apply changes (add/promote/demote)
3. Update `last_updated` timestamp
4. Regenerate `reality.md` from index.json
5. Update global `index.md` counts

### Read Reality File

1. Check if `{project_id}/reality.index.json` exists
2. If exists, parse JSON and return
3. If not exists, return null (trigger fresh start)

---

## Writing Best Practices

### Human-Readable (reality.md)

- Use consistent markdown formatting
- Include horizontal rules between tiers
- Keep assumptions readable without JSON
- Include history table for audit trail

### Machine-Readable (reality.index.json)

- Always valid JSON
- Include all fields (no omissions)
- Use ISO 8601 timestamps
- Preserve history array for audit

### Sync Rules

- `reality.index.json` is source of truth
- `reality.md` is generated from index.json
- Always update both on any change
- Never manually edit reality.md (regenerate instead)

---

## Error Handling

| Scenario | Action |
|----------|--------|
| No home directory access | Warn user, suggest alternate path |
| Corrupted index.json | Backup and regenerate from reality.md |
| Missing project directory | Create fresh on next run |
| Permission denied | Report error with path |
