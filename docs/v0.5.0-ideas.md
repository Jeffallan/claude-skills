# Workflow Commands Overhaul Plan (v0.5.0)

## Overview

Decouple workflow commands from Jira/Confluence, add per-project backend configuration, create a project intake phase, integrate feature-forge into the workflow pipeline, and fix the epic creation gap.

**Addresses:** Issues #62, #103, #109 | Discussion #112 | Feature-forge integration | Project intake process

---

## Architecture: Backend Adapter Pattern

Every command gains a Phase 0 config resolution step that loads backend-specific reference files:

```
.claude/workflow-config.json (in consumer project)
    ├── ticketing: "local" | "jira" | "github-issues"
    └── documentation: "local" | "confluence" | "github-wiki"

Command Phase 0:
  1. Read .claude/workflow-config.json (default: local/local)
  2. Load references/ticketing-{backend}.md
  3. Load references/docs-{backend}.md
  4. Proceed with abstract operations
```

All 9 existing commands replace hardcoded Jira/Confluence operations with abstract verbs ("create ticket", "publish document") and a routing table to backend-specific reference files.

---

## New Workflow Lifecycle

```
INTAKE (new)         → document-codebase → capture-behavior → create-system-description
                           ↓
FEATURE DEFINITION   → feature-forge (reads system description) → specs/{name}.spec.md
                           ↓
DISCOVERY            → create-epic-discovery → synthesize-discovery → approve-synthesis
                           ↓                                           (now auto-creates epics)
PLANNING             → create-epic-plan (reads feature spec) → create-implementation-plan
                           ↓
EXECUTION            → execute-ticket → complete-ticket (updates system description)
                           ↓
RETROSPECTIVES       → complete-epic (updates system description) → complete-sprint
```

**Total commands:** 12 (was 9)

---

## Phase 1: Configuration Schema & Backend Adapters

**Goal:** Create the shared reference files that all commands will depend on.

### Files to Create

| File | Purpose | ~Lines |
|------|---------|--------|
| `commands/project/references/workflow-config-schema.md` | JSON schema for `.claude/workflow-config.json` with examples for each backend combo | 200 |
| `commands/project/references/config-resolution.md` | How commands resolve config: find file → validate → load backends → fallback to local | 120 |
| `commands/project/references/ticketing-local.md` | Local markdown tickets: YAML frontmatter + body in `docs/epics/{phase}/{epic}/tickets/` | 150 |
| `commands/project/references/ticketing-jira.md` | Jira operations via Atlassian MCP; cross-refs `atlassian-mcp` skill | 150 |
| `commands/project/references/ticketing-github-issues.md` | GitHub Issues via `gh` CLI; labels as status, milestones as epics | 150 |
| `commands/project/references/docs-local.md` | Local markdown docs in structured `docs/` folder mirroring Confluence paths | 150 |
| `commands/project/references/docs-confluence.md` | Confluence operations via Atlassian MCP; cross-refs `atlassian-mcp` skill | 150 |
| `commands/project/references/docs-github-wiki.md` | GitHub Wiki pages via `gh` CLI | 100 |
| `commands/project/references/local-docs-structure.md` | Full local directory structure with Docusaurus setup guidance | 200 |

**Total:** 9 new files (~1,370 lines)

### Script Fix Required

**File:** `scripts/update-docs.py` (line 84-89)

`count_workflows()` uses `rglob("*.md")` which would count reference files. Fix to exclude `references/` subdirectories:

```python
def count_workflows(base_path: Path) -> int:
    """Count workflow command markdown files."""
    commands_dir = base_path / COMMANDS_DIR
    if not commands_dir.exists():
        return 0
    return sum(1 for f in commands_dir.rglob("*.md") if "references" not in f.parts)
```

---

## Phase 2: Decouple All 9 Existing Commands

**Goal:** Rewrite each command to use abstract operations with routing table.

Each command gets:
1. New Phase 0 step: config resolution (load backend refs)
2. All Jira/Confluence references → abstract operations ("create ticket", "publish document")
3. Routing table at bottom pointing to backend reference files
4. Backend-specific failure conditions generalized

| Command File | Refs to Abstract | Key Changes |
|-------------|-----------------|-------------|
| `discovery/create-epic-discovery.md` | 12 | Fetch epic → "query epic"; Publish to Confluence → "publish document" |
| `discovery/synthesize-discovery.md` | 6 | Source URLs → Source Refs (URLs or local paths); abstract publish |
| `discovery/approve-synthesis.md` | 11 | Create Jira tickets → "create tickets"; Epic Link → "link to epic" |
| `planning/create-epic-plan.md` | 16 | Highest coupling; JQL queries → "query child tickets"; 5 agent refs stay |
| `planning/create-implementation-plan.md` | 9 | Update Jira tickets → "update tickets"; Confluence plan → "publish plan" |
| `execution/execute-ticket.md` | 9 | Fetch Jira ticket → "fetch ticket"; status transitions abstracted |
| `execution/complete-ticket.md` | 12 | Transition Jira → "transition status"; Update Confluence → "update plan" |
| `retrospectives/complete-epic.md` | 11 | Close Jira → "close epic"; move Confluence pages → "move documents" |
| `retrospectives/complete-sprint.md` | 8 | Load Jira data → "load ticket data"; publish retro → "publish document" |

**Total:** 94 hardcoded references abstracted across 9 files

---

## Phase 3: Fix Epic Creation Gap (Issue #103)

**File:** `commands/project/discovery/approve-synthesis.md`

Insert **Phase 1.5: Epic Verification & Creation** between current Phase 1 (Decision Resolution) and Phase 2 (Ticket Review):

1. **Verify target epics exist** — query ticketing system for each referenced epic
2. **If missing, present options:**
   - **A) Auto-create** — present epic details for approval, create in batch, record ID mappings
   - **B) Map to existing** — query candidates, let user map proposed → existing epics
   - **C) Skip** — proceed without epic links (warning)
   - **D) Cancel** — abort for manual fix
3. **Error handling** — if batch creation fails mid-way, report successes/failures, offer retry
4. **Record mappings** — store in synthesis document for Phase 2 ticket creation

---

## Phase 4: Project Intake Commands (NEW)

**Goal:** 3 new commands under `commands/project/intake/` for codebase onboarding.

### 4.1 `commands/project/intake/document-codebase.md` (~250 lines)

```yaml
description: Use when onboarding a new project to add documentation to existing code
argument-hint: [--scope=<path>] [--format=<jsdoc|docstring|xml>]
```

**Workflow:** Scan codebase → identify undocumented functions/classes/modules → prioritize (public APIs first) → checkpoint approval → generate docstrings → output summary → pointer to `capture-behavior`

### 4.2 `commands/project/intake/capture-behavior.md` (~250 lines)

```yaml
description: Use when capturing existing system behavior through tests for an undocumented codebase
argument-hint: [--scope=<path>] [--type=<unit|integration|both>]
```

**Workflow:** Scan code → identify untested behavior → analyze coverage gaps → checkpoint test plan → generate characterization tests (assert CURRENT behavior) → run tests → output summary → pointer to `create-system-description`

### 4.3 `commands/project/intake/create-system-description.md` (~300 lines)

```yaml
description: Use when creating a living system description document for a project
argument-hint: [--output=<path>]
```

**Workflow:** Parallel agent analysis (architecture, security, API, data) → generate SOC2-style document with sections:
- System Purpose & Scope
- System Components (services, databases, queues, caches)
- Data Flow Diagram (mermaid)
- Security Architecture
- API Surface Area
- External Dependencies
- Infrastructure Overview
- Change Management Process

**Output:** `docs/system-description.md` (configurable path)

### 4.4 Intake Reference Files

| File | Purpose | ~Lines |
|------|---------|--------|
| `commands/project/intake/references/characterization-tests.md` | Patterns for behavior-capturing tests across languages | 200 |
| `commands/project/intake/references/system-description-template.md` | Full SOC2-style template with examples for web apps, APIs, microservices | 300 |

**Total Phase 4:** 5 new files (~1,300 lines)

---

## Phase 5: Feature-Forge Integration & System Description Updates

### 5.1 Feature-Forge Reads System Description

**File:** `skills/feature-forge/SKILL.md`

Add Step 0 to Core Workflow:
> 0. **Context** — Check for `docs/system-description.md` (or path from config). If found, load as background context. Reference existing components/APIs during interviews. Skip questions the system description already answers.

**New file:** `skills/feature-forge/references/system-context-integration.md` (~150 lines)
- How to use system description sections during requirements gathering
- Which sections inform which interview questions
- How specs should reference system components

### 5.2 Clarify Feature-Forge Output Boundaries

**File:** `skills/feature-forge/references/specification-template.md`

Add `## Workflow Integration` section:
- Epic Target field (epic key or "New Epic")
- Explicit note: "High-level TODOs only. Detailed implementation steps generated by `/create-implementation-plan`."
- This eliminates the duplicate implementation checklist problem

### 5.3 `create-epic-plan` Reads Feature Specs

**File:** `commands/project/planning/create-epic-plan.md`

Add to Phase 0:
> Check for `specs/{feature_name}.spec.md` related to this epic. If found, use requirements, acceptance criteria, and NFRs as input. Do not re-derive what the spec already defines.

### 5.4 System Description Updates on Completion

**File:** `commands/project/execution/complete-ticket.md` — Add Step 4c:
> Check for system description. If changes affect APIs, external deps, security, or data models → propose targeted updates → checkpoint approval → apply.

**File:** `commands/project/retrospectives/complete-epic.md` — Add to Phase 5:
> Review all changes across the epic. Update system description to reflect new system state. Update mermaid diagrams if architecture changed. Checkpoint approval.

---

## Phase 6: Documentation & Release

| File | Changes |
|------|---------|
| `docs/WORKFLOW_COMMANDS.md` | Major rewrite: add Configuration section, Intake Phase, all backends, feature-forge integration, updated lifecycle diagram, command table (12 commands) |
| `SKILLS_GUIDE.md` | Add feature-forge workflow integration notes |
| `README.md` | Update workflow section; note Atlassian MCP is now optional; add `.claude/workflow-config.json` reference |
| `ROADMAP.md` | Update #62, #103 status; add intake phase items |
| `CHANGELOG.md` | Add v0.5.0 entry |
| `docs/ATLASSIAN_MCP_SETUP.md` | Add note: only needed when config specifies jira/confluence backends |
| `version.json` | Bump to `0.5.0` |
| `.claude-plugin/plugin.json` | Add keywords: "local-first", "github-issues", "workflow-config" |

---

## Phase 7: Validation

1. `python scripts/validate-skills.py` — all skill YAML valid
2. `python scripts/update-docs.py --check` — counts in sync
3. `grep -r "Jira\|Confluence\|JQL\|Atlassian" commands/project/*.md commands/project/*/*.md` — verify no hardcoded refs remain in command files (only in `references/` backend files)
4. Verify all new files have valid frontmatter
5. Verify reference files are within 100-600 line range
6. `python scripts/update-docs.py` — propagate final counts
7. `node ./assets/capture-screenshot.js` — regenerate social preview

---

## File Manifest

### New Files (15 files, ~2,970 lines)

| Phase | File | ~Lines |
|-------|------|--------|
| 1 | `commands/project/references/workflow-config-schema.md` | 200 |
| 1 | `commands/project/references/config-resolution.md` | 120 |
| 1 | `commands/project/references/ticketing-local.md` | 150 |
| 1 | `commands/project/references/ticketing-jira.md` | 150 |
| 1 | `commands/project/references/ticketing-github-issues.md` | 150 |
| 1 | `commands/project/references/docs-local.md` | 150 |
| 1 | `commands/project/references/docs-confluence.md` | 150 |
| 1 | `commands/project/references/docs-github-wiki.md` | 100 |
| 1 | `commands/project/references/local-docs-structure.md` | 200 |
| 4 | `commands/project/intake/document-codebase.md` | 250 |
| 4 | `commands/project/intake/capture-behavior.md` | 250 |
| 4 | `commands/project/intake/create-system-description.md` | 300 |
| 4 | `commands/project/intake/references/characterization-tests.md` | 200 |
| 4 | `commands/project/intake/references/system-description-template.md` | 300 |
| 5 | `skills/feature-forge/references/system-context-integration.md` | 150 |

### Modified Files (20 files)

| Phase | File | Change Scope |
|-------|------|-------------|
| 1 | `scripts/update-docs.py` | Fix `count_workflows()` to exclude `references/` |
| 2 | `commands/project/discovery/create-epic-discovery.md` | Abstract 12 refs, add routing table |
| 2 | `commands/project/discovery/synthesize-discovery.md` | Abstract 6 refs, add routing table |
| 2+3 | `commands/project/discovery/approve-synthesis.md` | Abstract 11 refs + add Phase 1.5 epic creation |
| 2+5 | `commands/project/planning/create-epic-plan.md` | Abstract 16 refs + read feature specs |
| 2 | `commands/project/planning/create-implementation-plan.md` | Abstract 9 refs |
| 2 | `commands/project/execution/execute-ticket.md` | Abstract 9 refs |
| 2+5 | `commands/project/execution/complete-ticket.md` | Abstract 12 refs + system desc update |
| 2+5 | `commands/project/retrospectives/complete-epic.md` | Abstract 11 refs + system desc update |
| 2 | `commands/project/retrospectives/complete-sprint.md` | Abstract 8 refs |
| 5 | `skills/feature-forge/SKILL.md` | Add system description context step |
| 5 | `skills/feature-forge/references/specification-template.md` | Add workflow integration section |
| 6 | `docs/WORKFLOW_COMMANDS.md` | Major rewrite |
| 6 | `SKILLS_GUIDE.md` | Feature-forge integration notes |
| 6 | `README.md` | Update workflow section |
| 6 | `ROADMAP.md` | Update issue statuses |
| 6 | `CHANGELOG.md` | Add v0.5.0 entry |
| 6 | `docs/ATLASSIAN_MCP_SETUP.md` | Mark as optional |
| 6 | `version.json` | Bump to 0.5.0 |
| 6 | `.claude-plugin/plugin.json` | Update keywords |

### Dependency Order

```
Phase 1 (adapters) → Phase 2 (decouple commands) → Phase 3 (epic fix, builds on Phase 2 approve-synthesis)
Phase 1 (adapters) → Phase 4 (intake, needs config schema)
Phase 4 (intake)   → Phase 5 (feature-forge, needs system description to exist)
All above          → Phase 6 (docs) → Phase 7 (validation)
```

Phases 2-4 can partially overlap since Phase 4 only depends on Phase 1 (not Phase 2).
